#!/bin/sh

processIDScript=$$
CUR_DIR="/analysis"
MALWARE_FILE=$1
ITERATION=$2
RESULT_DIR=$CUR_DIR/result/$MALWARE_FILE/$ITERATION
mkdir -p $RESULT_DIR/log $RESULT_DIR/syscalls $RESULT_DIR/pcap

if [ $MALWARE_FILE == victim* ]; then
  ps > $RESULT_DIR/processesForSyscalls
  ps | awk '{print $1}' | sed -e '/^PID/d' | sed -e 's/\([0-9]*\)/\-tttTp \1/g' > $RESULT_DIR/allProcesses
  awk "!/-tttTp $processIDScript/" $RESULT_DIR/allProcesses > $RESULT_DIR/tmp && mv $RESULT_DIR/tmp  $RESULT_DIR/allProcesses
  echo " -tttfTp 1 " >> $RESULT_DIR/allProcesses
  strace -s999 `cat $RESULT_DIR/allProcesses` -o $RESULT_DIR/syscalls/$MALWARE_FILE.log
else
  cp $MALWARE_FILE /malware && chmod 777 /malware
#  tcpdump -i eth0 -w  $RESULT_DIR/pcap/traffic.pcap &
  ln /usr/bin/strace bob
  ./bob -ftttT -s999 /malware 2>$RESULT_DIR/syscalls/$MALWARE_FILE.log >$RESULT_DIR/log/$MALWARE_FILE.out
fi
